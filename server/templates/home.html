<html>
	<head>
	<style>
body {
	margin: 0;
	padding: 0;
}

#error {
	color: #f00;
}
#device_id, #screen_id, #url {
	font-weight: bold;
}
	</style>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
	<script src="/static/jquery.cookie.js" type="text/javascript"></script>
	<script>

function onError(msg) {
	$('body').css('background-color', '#fdd');
	$('#error').html(msg);
	//$('#dash').show();
}

function hackFrameBusting() {
	//$("#content")[0].contentDocument.designMode = "on";
}

function autoHeight() {
	var browserHeight = $(window).height();
	var dashHeight = $("#dash").height();
	var contentHeight = browserHeight - dashHeight;
	$("#content_div").height(contentHeight);
}

var lastCastTimer = null;
var lastCastUrl = null;

function onIframeFail() {
	onError("Iframe failed to load.");
	//window.open(lastCastUrl);
}

function onIframeLoad(){
	if (lastCastTimer)
		clearTimeout(lastCastTimer);
	$('body').css('background-color', '#fff');
	$("#content_div").scrollTop(0);
	//$('#dash').slideUp();
}

var prevent_bust = 0
window.onbeforeunload = function() { prevent_bust++ }
setInterval(function() {
	if (prevent_bust > 0) {
		prevent_bust -= 2
		window.top.location = '/204/'
	}
}, 1)

var reconnectFails = 0;

function reconnect() {
	$('#error').html('');
	$('body').css('background-color', '#fff');
	listenBroadcast();
}

function listenBroadcast() {
	$.get('/screens/' + SCREEN_ID, '',
		function(msg) {
			reconnectFails = 0;
			if (msg.result == 'ok') {
				$('#error').html('');				
				var data = JSON.parse(msg.data);
				if (data.url) {
					lastCastUrl = data.url;
					$('#url').html(lastCastUrl);
					$('#content').attr('src', lastCastUrl);
					$('body').css("background-color","#ddf");
					if (lastCastTimer)
						clearTimeout(lastCastTimer);
					//lastCastTimer = setTimeout(onIframeFail, 10000);
				} else if (data.action == 'u') {
					scrollUp();
				} else if (data.action == 'd') {
					scrollDown();
				}
				listenBroadcast();
				
			} else if (msg.result == 'resubscribe') {
				listenBroadcast();
			} else {
				onError("Ajax error: " + msg.result);
			}
		}, 'json')
		.error(function() {
			var secs = Math.pow(2, Math.min(reconnectFails, 6));
			++reconnectFails;
			onError('Ajax error: Connection failed. Reconnecting in ' + secs + ' seconds (attempt #' + reconnectFails + ')...');
			setTimeout(reconnect, secs * 1000);
		});
		
}

function onGotScreenId() {
	$('#screen_id').html(SCREEN_ID);
	listenBroadcast();
}

function getScreenId() {
	// registers this device
	$.post('/screens/', 'device_id=' + DEVICE_ID,
		function(msg) { // callback
			if (msg.screen_id) {
				SCREEN_ID = msg.screen_id;
				$.cookie("screen_id", SCREEN_ID);
				onGotScreenId();
			} else {
				onError("Ajax error: " + String(msg));
			}
		}, 'json')
		.error(function() {
			onError('Ajax error: Connection failed.');
		});
}

$(function() {
	DEVICE_ID = $.cookie("device_id");
	if (!DEVICE_ID) {
		DEVICE_ID = Math.floor(Math.random() * 100000000) + 1;
		$.cookie("device_id", DEVICE_ID);
	}
	$('#device_id').html(DEVICE_ID);

	SCREEN_ID = $.cookie("screen_id");
	if (SCREEN_ID) {
		onGotScreenId();
	} else {
		getScreenId();
	}

	autoHeight();
	$('#content').load(onIframeLoad);
	hackFrameBusting();
});

function genKeyEvent(type, char) {
	var pressEvent = document.createEvent('KeyboardEvent');
	pressEvent.initKeyEvent(type, true, true, null, 
				false, false, false, false, 
				0, char);
	return pressEvent;
}

function pressChar(char)
{
	try {
		var c = char.charCodeAt(0);
		$('#error').html("You pressed: code=" + c + " char=" + char);
		var element = $('#content')[0].contentWindow.document.activeElement;
		element.dispatchEvent(genKeyEvent("keypress", c));
	} catch (e) {
		alert("Your browser does not support this example!");
	}
}

function testKey() {
	setTimeout(function(){
		pressChar('s');
		pressChar('\t');
	}, 3000);
}

function scrollDown() {
	var div = $("#content_div");
	div.animate({scrollTop: div.scrollTop() + 0.5 * div.height()}, 200);
}

function scrollUp() {
	var div = $("#content_div");
	div.animate({scrollTop: div.scrollTop() - 0.5 * div.height()}, 200);
}
	</script>
	</head>
	<body>
	<table id=dash width=100%>
		<tr><td nowrap align=left><a href="javascript:void(0)" onclick="testKey()">Test sim key</a> | <a href="javascript:void(0)" onclick="scrollDown()">Test sim down</a> | <a href="javascript:void(0)" onclick="scrollUp()">Test sim up</a> | Dropcast URL: <span id=url>[None]</span></td><td nowrap align=right>Device ID: <span id=device_id>Unknown</span> Screen ID: <span id=screen_id>Unknown</span></td></tr>
		<tr><td id=error></td></tr>
	</table>
	<div id=content_div style="width: 100%; overflow: auto; border-top: 1px solid #000;">
	<iframe id=content src="/static/test.html" style="width:100%; height: 2300px; border: 0" scrolling="no"></iframe>
	</div>
	</body>
</html>

